# 3 Embedded part 嵌入式部分

## 3.1 Snapshort 整体方案

下位机的任务要求应当达到, 对底盘的控制, 云台的控制, 发弹机构(包括摩擦轮, 拨盘)的控制, 与上位机的通信, 整体的框架如下:

<div align="center">
    <img src=figures/main_control.png width="360px"/>
</div>
<div align="center">主控板通信框架</div>

其中, 下位机与底盘的4个电机, 发弹机构的3个电机和云台的2个电机使用CAN1来通信, 与上位机使用CAN2来通信.
这里我们认为CAN要比UART的通信速率要快, 而且功能强大, 不分主从, 比如对实时控制来说, CAN的实现要比UART来的更加容易.

对于ICRA来说, 我们定义了几个基本的需要实现的功能:

- 第一个功能是移动自主机器人补给子弹, 由于比赛规则规定, 比赛开始时, 两台机器人其中一辆是没有子弹的, 故补给子弹便成了比较重要的需要实现的功能.
- 第二个功能是机器人在补给子弹的过程中, 或是巡逻的过程中, 在没有发现敌人的情况下, 能够进行灵活的移动来躲避敌人的攻击, 并试图发现敌人的方位.
- 第三个功能是在发现了并识别到了敌人的情况下, 底盘能够跟踪敌人, 云台能够跟随敌人, 或者由决策层决定其他方案.

### 3.1.1 补给

通过雷达实现定位, 而后由路径规划算法规划出移动到补给点的路线, 再由下位机接收上位机发送的电机信息控制数据.
此时, 如果在移动中, 或是补给中受到了打击, 将进行3.1.2躲避的程序.
到达大概的补给点位置后, 将处理机器人4个方位的超声波模块的数据, 对定位数据进行修正以至于减少误差, 并且通过阀值来确定是否正确到达补给点.

### 3.1.2 躲避

下位机与裁判系统相互通信, 当机器人被攻击时, 下位机获取信息, 得知正在被攻击, 哪个装甲板正在被攻击, 转发信息给上位机.
上位机得到被攻击的消息后, 判断出是在没有发现敌人的情况下被攻击的, 故采取躲避的行动.

躲避行动有:

1. 开启底盘摇摆模式

2. 开启底盘摇摆模式同时沿着预估子弹发射方向的垂直方向移动, 并且云台沿着预估子弹发射方向转向.

3. 开启地图四角逃窜模式

当进行子弹补给的任务时, 被敌人攻击, 采取逃避方案1.
当子弹补给任务完毕, 并且自身血量良好, 高于良好阀值, 便采取逃避方案2.
当子弹补给任务完毕, 并且自身血量危险, 低于危险阀值, 便采取逃避方案3.

### 3.1.3 反击或是其他



## 3.2 Robot Base Control 机器人底盘控制

### 底盘

底盘控制主控使用RM A型开发板，对单个电机的控制采用位置、速度双闭环的pid控制器，外环为位置环，每周期的目标输入是每周期的码盘步长的期望值。
在位置环外对每周期的输入期望值和每周期完成值做积分，将误差补偿到下周期的期望值上。
速度环的速度采样使用卡尔曼滤波器对速度值进行平滑处理，使得速度控制更为平滑准确。

### 云台

云台控制和底盘控制在同一块板上进行，我们将主控放在云台上。
云台同样使用位置、速度双闭环控制，云台pitch轴和yaw轴的数据采样都使用mpu6500。
首先获取惯导数据，进行低通滤波，以500Hz频率使用Mahony互补滤波器和四元数对加速度和角速度数据进行融合解算（参考px4开源飞控），得到云台姿态数据。
Yaw轴获取云台电机码盘数据，得到云台和底盘的相对角度，用于限位和校准姿态解算后的yaw轴。
用mpu6050做观测器的优势在于可以轻松做到扭腰模式。

## 2.3 Robot Gimbal Control 机器人云台控制
